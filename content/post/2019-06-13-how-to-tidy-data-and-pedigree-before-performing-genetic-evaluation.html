---
title: "常规遗传评估需要的数据格式和整理步骤"
author: "Sheng Luan"
date: '2019-06-13'
header:
  caption: ''
  image: ''
  preview: yes
slug: how-to-tidy-data-and-pedigree-before-performing-genetic-evaluation
tags:
- R
- data tidy
categories: 数据清洗
---



<div id="section" class="section level2">
<h2>文件格式</h2>
<ul>
<li>育种数据分析，主要用到2个文件，系谱文件和数据文件。</li>
<li>系谱文件和数据文件，保存为.csv格式或者.xlsx格式都可以。csv格式就是逗号分隔的文本格式。具体保存方法，在excel中输入数据后，点击保存，选择格式。</li>
<li>数据文件名表示方式：性状前缀+世代名称Data.csv，譬如中国对虾2015年生长测试数据文件，可以用g2015G11Data.csv表示。</li>
<li>系谱文件名表示方式：性状前缀++世代名称Ped.csv，譬如中国对虾2015年系谱文件，可以用g2015G11Ped.csv表示。</li>
<li>如果是基于分子亲缘关系逆矩阵分析，通常扩展名为giv文件，每一列通过空格或者制表符分割。</li>
</ul>
</div>
<div id="section-1" class="section level2">
<h2>通用规则</h2>
<ul>
<li>数据按照行保存，每一行是一个个体的记录。每一列表示不同的变量，如个体编号，父本编号，性别，出生年份等信息。</li>
<li>第一行一般是表头，表示该列字段的意义。譬如第一列是个体编号，通常在第一行用AnimalID来表示。第二列是父本编号，通常用SireID表示。</li>
<li>约定俗成的规定，表头一般用<strong>英文字符</strong>如AnimalID等来表示，因为某些统计分析或者数据处理软件软件不兼容中文。</li>
<li>数据文件中，缺失的数据元素，用NA表示。譬如，如果看不出某只虾的性别，用NA代替。如果某只虾的性别鉴定不出来，也用NA表示。</li>
<li>数据文件中，性状关联字段，如<strong>收获体重</strong>、<strong>标记时体重</strong>等数值字段，务必请检查数据范围，修正明显超出范围的错误值。譬如收获体重均值为10g，如果某只虾的体重为300g、1000g，明显是输入错误；如果存在0.01g，很大概率也是输入错误。</li>
<li>对于性状、测试池等分类字段，可以利用Excel中的筛选功能，查看每个字段有多少个水平。譬如性别列，如果出现Male、male、 Female、F、female等，需要统一修正为仅包括两种性别。</li>
<li>当用Excel整理数据时，一定要确保单元格中不能为空，如果没有值，用NA填充。系谱文件例外，见下文。</li>
<li>如果用ASReml软件进行遗传评估，生成的扩展名为.ass的数据汇总文件务必要首先查看，核对数据是否准确。</li>
<li>推荐利用R包DataExplorer包对待分析数据进行检查。</li>
</ul>
</div>
<div id="section-2" class="section level2">
<h2>系谱文件</h2>
<ul>
<li>系谱文件有三个字段，分别为个体编号、父本编号和母本编号；</li>
<li>系谱文件个体数据要按照规则排序：一个个体的父母本系谱信息必须出现在该个体前边；</li>
<li>如果个体的父本和母本未知，用<strong>0</strong>代替。父本和母本要么都为0，如果只知道已授精的母本，父本也要编一个号码；</li>
<li>如果系谱文件和数据文件共用一个文件，那么文件的前三列将是个体编号、父本编号和母本编号；</li>
<li>如果父本编号和母本编号两列中的个体没有在个体编号列中出现，将会默认为奠基者个体。</li>
<li>在第四列加入个体的性别是一个好的建议。</li>
<li>可以利用optiSel、visPedigree等R包实现对系谱文件的整理</li>
<li>visPeidgree包的<a href="https://luansheng.netlify.com/post/the-first-package-vispedigree-0-1/">中文安装和使用说明</a></li>
</ul>
</div>
<div id="section-3" class="section level2">
<h2>数据处理实例</h2>
<pre class="r"><code>knitr::opts_chunk$set(echo = TRUE)
rm(list=ls()) #清空已存在的各种对象和变量
library(data.table) 
library(visPedigree)
library(DataExplorer)</code></pre>
<div id="section-4" class="section level3">
<h3>1.读取系谱和数据文件</h3>
<p><a href="/post/datasets/g2016G0to2017G1Ped.csv">数据文件</a>和<a href="/post/datasets/g2016G0to2017G1Data.csv">系谱文件</a>可以点击下载。</p>
<p>下载后，跟R代码放在同一目录下，如果不打算修改下述代码，那么把数据和系谱文件放在一个新建目录datasets下。datasetsw文件夹和R脚本文件在同一个目录下。</p>
<pre class="r"><code>gPed &lt;-
  fread(
    file = &quot;datasets/g2016G0to2017G1Ped.csv&quot;,
    sep = &quot;,&quot;,
    stringsAsFactors = FALSE,
    header = TRUE
  )
gData &lt;-
  fread(
    file = &quot;datasets/g2016G0to2017G1Data.csv&quot;,
    sep = &quot;,&quot;,
    stringsAsFactors = FALSE,
    header = TRUE
  )
gPed$Sex[gPed$Sex == &quot;0&quot;] &lt;- NA</code></pre>
</div>
</div>
<div id="section-5" class="section level2">
<h2>2. 数据检查</h2>
<p>检查数据中分类以及连续性变量的分布，主要是发现是否有异常值。</p>
<p>根据柱状图，可以查看世代、池塘、性别等分类变量的水平数。如果性别有三个，很容易可以查看出来。</p>
<p>根据直方图，可以检查体重、体长、日龄等连续变量的分布，如果有异常值，也非常容易查看。</p>
<p>连续性变量之间的散点图和相关图，用来发现不同变量间的趋势，也是非常有用的工具。</p>
<pre class="r"><code>#检查分类变量
plot_bar(gData)</code></pre>
<pre><code>## 4 columns ignored with more than 50 categories.
## AnimalID: 11413 categories
## SireID: 90 categories
## DamID: 120 categories
## FamilyID: 120 categories</code></pre>
<p><img src="/post/2019-06-13-how-to-tidy-data-and-pedigree-before-performing-genetic-evaluation_files/figure-html/check_data-1.png" width="672" /></p>
<pre class="r"><code>#检查连续性变量
plot_histogram(gData)</code></pre>
<p><img src="/post/2019-06-13-how-to-tidy-data-and-pedigree-before-performing-genetic-evaluation_files/figure-html/check_data-2.png" width="672" /></p>
<pre class="r"><code>#检查连续性变量与收获体重间的散点图
plot_scatterplot(split_columns(gData)$continuous, by = &quot;M2BW&quot;)</code></pre>
<p><img src="/post/2019-06-13-how-to-tidy-data-and-pedigree-before-performing-genetic-evaluation_files/figure-html/check_data-3.png" width="672" /></p>
<pre class="r"><code>#检查连续性变量间的相关性
plot_correlation(gData, type = &quot;continuous&quot;)</code></pre>
<p><img src="/post/2019-06-13-how-to-tidy-data-and-pedigree-before-performing-genetic-evaluation_files/figure-html/check_data-4.png" width="672" /></p>
</div>
<div id="section-6" class="section level2">
<h2>3.预处理系谱、提纯系谱、数字化系谱</h2>
<p>visPedigree包中的tidyped()函数，主要有两个功能:</p>
<ul>
<li>包括了自动补全不在系谱ID列中的个体号，以及提纯功能。</li>
<li>把与当前数据集中个体没有亲缘关系的系谱个体，全部剔除掉</li>
</ul>
<pre class="r"><code>#预处理系谱，主要是把父母本的系谱设置为0
gPed_tidy &lt;- tidyped(ped = gPed, cand  = gData$AnimalID)</code></pre>
<pre><code>## Warning in checkped(ped, addgen): In the sire or dam column, Blank, Zero,
## asterisk, or character NA is recognized as a missing parent and is replaced
## with the missing value NA.</code></pre>
<pre class="r"><code>gPed_tidy</code></pre>
<pre><code>##                    Ind            Sire             Dam    Sex Offspring
##     1: OLHBB14B000F001            &lt;NA&gt;            &lt;NA&gt; female      TRUE
##     2: OLHBB14B000F002            &lt;NA&gt;            &lt;NA&gt; female      TRUE
##     3: OLHBB14B000F003            &lt;NA&gt;            &lt;NA&gt; female      TRUE
##     4: OLHBB14B000F004            &lt;NA&gt;            &lt;NA&gt; female      TRUE
##     5: OLHBB14B000F005            &lt;NA&gt;            &lt;NA&gt; female      TRUE
##    ---                                                                 
## 11914: OXHMB17G0110820 OLHBC16G000M088 OLHBC16G000F088   male     FALSE
## 11915: OXHMB17G0110821 OLHBC16G000M088 OLHBC16G000F088   male     FALSE
## 11916: OXHMB17G0110822 OLHBC16G000M088 OLHBC16G000F088   male     FALSE
## 11917: OXHMB17G0110823 OLHBC16G000M088 OLHBC16G000F088   male     FALSE
## 11918: OXHMB17G0110824 OLHBC16G000M088 OLHBC16G000F088   male     FALSE
##        Year   Breed  Cand Gen IndNum SireNum DamNum
##     1: 2014      DP FALSE   1      1       0      0
##     2: 2014      DP FALSE   1      2       0      0
##     3: 2014      DP FALSE   1      3       0      0
##     4: 2014      DP FALSE   1      4       0      0
##     5: 2014      DP FALSE   1      5       0      0
##    ---                                             
## 11914: 2017 unknown  TRUE   4  11914     350    332
## 11915: 2017 unknown  TRUE   4  11915     350    332
## 11916: 2017 unknown  TRUE   4  11916     350    332
## 11917: 2017 unknown  TRUE   4  11917     350    332
## 11918: 2017 unknown  TRUE   4  11918     350    332</code></pre>
<p>整理后系谱的包含的个体数，要少于原始系谱。</p>
</div>
<div id="section-7" class="section level2">
<h2>4.画出个体的系谱树</h2>
<p>侧面验证一下提纯后的系谱，是否正确。</p>
<p>从数据集中最后一尾虾，画出系谱图。</p>
<p>这里需要注意的是，<code>visped()</code>函数要求个体的父本和母本，要么双亲独有，要么都没有，不能一个有，一个没有。</p>
<p>实际上可能会存在这样一个情况，像两只已经交尾的母虾，有可能来自同一尾公虾，但是即便是这种情况，也需要给父本一个随机编号，假定他们是各不相同的。</p>
<p>即便是设置为缺失，应该也是这种情况。</p>
<pre class="r"><code>one_pedigree &lt;-
  tidyped(ped = gPed_tidy, cand = gData$AnimalID[nrow(gData)])</code></pre>
<pre><code>## Warning in tidyped(ped = gPed_tidy, cand = gData$AnimalID[nrow(gData)]):
## The column Cand of the original pedigree is deleted.</code></pre>
<pre><code>## Warning in tidyped(ped = gPed_tidy, cand = gData$AnimalID[nrow(gData)]):
## The column Gen of the original pedigree is deleted.</code></pre>
<pre><code>## Warning in tidyped(ped = gPed_tidy, cand = gData$AnimalID[nrow(gData)]):
## The columns IndNum,SireNum,DamNum of the original pedigree are deleted.</code></pre>
<pre class="r"><code>visped(ped = one_pedigree)</code></pre>
<pre><code>## The cex for individual label is 0.7.</code></pre>
<pre><code>## Please decrease or increase the value of the parameter cex if the label&#39;s width is longer or shorter than that of the circle or square in the graph.</code></pre>
<pre><code>## It is recommended that the pedigree graph is saved in the pdf file using the parameter file</code></pre>
<pre><code>## The graph in the pdf file is a vector drawing: shapes, labels and lines are legible; shapes and labels isn&#39;t overlapped.</code></pre>
<p><img src="/post/2019-06-13-how-to-tidy-data-and-pedigree-before-performing-genetic-evaluation_files/figure-html/plotPedigree-1.png" width="960" /></p>
</div>
<div id="section-8" class="section level2">
<h2>4.输出系谱</h2>
<p>输出系谱时，设置缺失的父本和母本编号为0。</p>
<p><code>fwrite()</code>函数来自data.table包。</p>
<pre class="r"><code>gPed_tidy[is.na(Sire), Sire := &quot;0&quot;]
gPed_tidy[is.na(Dam), Dam := &quot;0&quot;]
fwrite(
  gPed_tidy,
  file = &quot;datasets/g2016G0to2017G1Pedpruned.csv&quot;,
  sep = &quot;,&quot;,
  row.names = F,
  na = &quot;NA&quot;,
  quote = FALSE
)</code></pre>
</div>
